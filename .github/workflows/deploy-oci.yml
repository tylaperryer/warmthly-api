name: Deploy to OCI Container Instance

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGION: us-ashburn-1
  OCI_REGISTRY: iad.ocir.io
  IMAGE_NAME: warmthly-api
  CONTAINER_NAME: warmthly-api
  SHAPE: CI.Standard.A1.Flex
  OCPUS: 1
  MEMORY_GB: 6

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to OCI Container Registry
        env:
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          OCI_PASSWORD: ${{ secrets.OCI_AUTH_TOKEN }}
          OCI_NAMESPACE: ${{ secrets.OCI_NAMESPACE }}
        run: |
          echo "$OCI_PASSWORD" | docker login ${OCI_REGISTRY} -u ${OCI_NAMESPACE}/${OCI_USERNAME} --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${OCI_REGISTRY}/${OCI_NAMESPACE}/${IMAGE_NAME}:latest .
          docker build -t ${OCI_REGISTRY}/${OCI_NAMESPACE}/${IMAGE_NAME}:${{ github.sha }} .

      - name: Push Docker image
        run: |
          docker push ${OCI_REGISTRY}/${OCI_NAMESPACE}/${IMAGE_NAME}:latest
          docker push ${OCI_REGISTRY}/${OCI_NAMESPACE}/${IMAGE_NAME}:${{ github.sha }}

      - name: Configure OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
        with:
          cli-version: latest
          config-file-content: ${{ secrets.OCI_CONFIG_FILE }}

      - name: Get current container instance info
        id: get-current
        run: |
          # Try to get existing container instance OCID from workflow env or file
          CURRENT_OCID="${{ secrets.CONTAINER_INSTANCE_OCID }}"
          if [ -z "$CURRENT_OCID" ]; then
            echo "No existing container instance OCID found, will create new one"
            echo "is_new=true" >> $GITHUB_OUTPUT
          else
            echo "Found existing container instance: $CURRENT_OCID"
            echo "is_new=false" >> $GITHUB_OUTPUT
            echo "current_ocid=$CURRENT_OCID" >> $GITHUB_OUTPUT
          fi

      - name: Create new container instance
        id: create-instance
        env:
          COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
          SUBNET_OCID: ${{ secrets.OCI_SUBNET_OCID }}
          VCN_OCID: ${{ secrets.OCI_VCN_OCID }}
        run: |
          # Create container instance with secrets from GitHub Secrets
          echo "Creating new container instance..."
          
          # Build environment variables JSON
          ENV_VARS=$(cat <<EOF
          {
            "PORT": "80",
            "YOCO_SECRET_KEY": "${{ secrets.YOCO_SECRET_KEY }}",
            "HUGGINGFACE_API_KEY": "${{ secrets.HUGGINGFACE_API_KEY }}",
            "LIBRETRANSLATE_URL": "${{ secrets.LIBRETRANSLATE_URL }}",
            "LIBRETRANSLATE_API_KEY": "${{ secrets.LIBRETRANSLATE_API_KEY }}",
            "LE_EMAIL": "${{ secrets.LE_EMAIL }}",
            "LE_STAGING": "${{ secrets.LE_STAGING || 'false' }}"
          }
          EOF
          )
          
          # Create container instance
          CREATE_RESPONSE=$(oci container-instances container-instance create \
            --compartment-id "${COMPARTMENT_OCID}" \
            --display-name "${CONTAINER_NAME}-$(date +%s)" \
            --shape "${SHAPE}" \
            --shape-config "{\"ocpus\": ${OCPUS}, \"memoryInGBs\": ${MEMORY_GB}}" \
            --containers "[{
              \"displayName\": \"api\",
              \"imageUrl\": \"${OCI_REGISTRY}/${OCI_NAMESPACE}/${IMAGE_NAME}:latest\",
              \"environmentVariables\": ${ENV_VARS},
              \"resourceConfig\": {
                \"vcpus\": ${OCPUS},
                \"memoryInGBs\": ${MEMORY_GB}
              }
            }]" \
            --vnics "[{
              \"subnetId\": \"${SUBNET_OCID}\",
              \"isPublicIpAssigned\": true
            }]" \
            --wait-for-state RUNNING \
            --max-wait-seconds 600 \
            --output json)
          
          # Extract new container instance OCID
          NEW_OCID=$(echo "$CREATE_RESPONSE" | jq -r '.data.id')
          NEW_PUBLIC_IP=$(echo "$CREATE_RESPONSE" | jq -r '.data.vnics[0].public-ip // "pending"')
          
          echo "✅ New container instance created!"
          echo "New OCID: $NEW_OCID"
          echo "Public IP: $NEW_PUBLIC_IP"
          
          echo "new_ocid=$NEW_OCID" >> $GITHUB_OUTPUT
          echo "new_public_ip=$NEW_PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Wait for health check
        run: |
          NEW_IP="${{ steps.create-instance.outputs.new_public_ip }}"
          if [ "$NEW_IP" != "pending" ] && [ "$NEW_IP" != "null" ]; then
            echo "Waiting for health check..."
            for i in {1..30}; do
              if curl -f -s "http://${NEW_IP}/health" > /dev/null; then
                echo "✅ Health check passed!"
                exit 0
              fi
              echo "Attempt $i/30: Health check failed, retrying in 10 seconds..."
              sleep 10
            done
            echo "⚠️ Health check timeout, but container is running"
          else
            echo "⚠️ Public IP not yet assigned, skipping health check"
          fi

      - name: Delete old container instance
        if: steps.get-current.outputs.is_new == 'false'
        env:
          OLD_OCID: ${{ steps.get-current.outputs.current_ocid }}
        run: |
          echo "Deleting old container instance: $OLD_OCID"
          oci container-instances container-instance delete \
            --container-instance-id "$OLD_OCID" \
            --force \
            --wait-for-state DELETED \
            --max-wait-seconds 300 || echo "⚠️ Failed to delete old instance (may already be deleted)"
          echo "✅ Old container instance deleted"

      - name: Deployment status
        run: |
          echo "✅ Deployment complete!"
          echo "New Container Instance OCID: ${{ steps.create-instance.outputs.new_ocid }}"
          echo "New Public IP: ${{ steps.create-instance.outputs.new_public_ip }}"
          echo ""
          echo "⚠️ IMPORTANT: Update CONTAINER_INSTANCE_OCID in GitHub Secrets:"
          echo "   Go to: Settings → Secrets and variables → Actions"
          echo "   Update: CONTAINER_INSTANCE_OCID = ${{ steps.create-instance.outputs.new_ocid }}"
          echo ""
          echo "API URL: http://${{ steps.create-instance.outputs.new_public_ip }}"
